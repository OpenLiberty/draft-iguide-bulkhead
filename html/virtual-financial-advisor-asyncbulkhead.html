<div id="asyncBulkheadStep" class="pod-animation-slide-from-right" tabindex="0">
    <div class="virtualFinancialAdvisorNewSession">
        <button class="newSessionButton" aria-label="New virtual financial advisor session request">
            <img src="/guides/draft-iguide-bulkhead/html/images/chat-message_32.svg" class="chatMessageImg" alt="chat"/>
            <spam class="chatText">Chat with a financial advisor</spam>
        </button>
    </div>
    <div class='browserHolder'></div>
</div>
<script>
    var stepName = "AsyncBulkheadAnnotation";
    var numOfRequests = 0;
    var browserVirtualAdvisorBaseURL = "https://global-ebank.openliberty.io/virtualFinancialAdvisor/";
    var browser;
    var advisors = ["Bob", "Jenny", "John", "Mary", "Lee", "Mike", "Sam", "Sandy", "Joann", "Frank" ];
    var advisorColors = ['royalblue', 'gray', 'seagreen'];

    var content = {
        url: "https://global-ebank.openliberty.io/",
        statusBarText: ""
        //browserContent: "/guides/draft-iguide-bulkhead/html/bank.html",
        //callback: "(function test(webBrowser) {bulkheadCallBack.listenToBrowserForNewSessionRequest(webBrowser, stepName); })"
    };
    webBrowser.create($('#asyncBulkheadStep').find('.browserHolder'), stepName,  content).done(function(newWebBrowser){
        contentManager.setWebBrowser(stepName, newWebBrowser, 0);
        browser = newWebBrowser;
    });

    $requestButtonElement = $('#asyncBulkheadStep').find('.newSessionButton');
    $requestButtonElement.on("keydown", function (event) {
        event.stopPropagation();
        if (event.which === 13 || event.which === 32) { // Enter key, Space key
            __handleRequest();
        }
    });
    $requestButtonElement.on("click", function (event) {
        event.stopPropagation();
        __handleRequest();
    });
    var __handleRequest = function() {
        contentManager.markCurrentInstructionComplete(stepName);
        contentManager.updateWithNewInstructionNoMarkComplete(stepName);
        numOfRequests++;
        console.log("numOfRequests ", numOfRequests);
        
        browserContentHTML = "/guides/draft-iguide-bulkhead/html/virtual-financial-advisor-chat.html";
        //statusBarMessage = "You are talking to advisor # " + numOfRequests + " out of 2 avaiable";     
        if (numOfRequests > 3) {
            console.log("retry");
            browserContentHTML = "/guides/draft-iguide-bulkhead/html/virtual-financial-advisor-asyncbulkhead-error.html";
            statusBarMessage = "Error";
        } else if (numOfRequests > 2) {
            console.log("waiting queue");
            browserContentHTML = "/guides/draft-iguide-bulkhead/html/virtual-financial-advisor-waitingqueue.html";
            statusBarMessage = "Waiting queue";
        }
        contentManager.setBrowserURL(stepName, browserVirtualAdvisorBaseURL + "Advisor" + numOfRequests, 0);
        //browser.setBrowserStatusBar(statusBarMessage);
        browser.setBrowserContent(browserContentHTML);

        if (numOfRequests < 3) {
            setTimeout(function (numOfRequest) {
                var advisor = advisors[numOfRequests - 1];
                var advisorBackgroundColor = advisorColors[numOfRequests - 1];
                var chatAdvisorCount  = "You are talking to advisor #" + numOfRequests;
                var chatIntro = "Hi, I am " + advisor + ", a financial advisor from Global eBank. Let me review your account. I'll be with you shortly."
                browser.getIframeDOM().find(".chatAdvisorCount").text(chatAdvisorCount);
                browser.getIframeDOM().find(".advisor").css("background-color", advisorBackgroundColor);
                browser.getIframeDOM().find(".advisor").text(chatIntro);
            }, 100);
        }
    }
</script>